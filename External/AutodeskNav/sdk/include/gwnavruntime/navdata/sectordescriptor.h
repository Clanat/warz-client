/*
* Copyright 2013 Autodesk, Inc. All rights reserved.
* Use of this software is subject to the terms of the Autodesk license agreement and any attachments or Appendices thereto provided at the time of installation or download,
* or which otherwise accompanies this software in either electronic or hard copy form, or which is signed by you and accepted by Autodesk.
*/


// primary contact: LASI - secondary contact: GUAL
#ifndef Navigation_SectorDescriptor_H
#define Navigation_SectorDescriptor_H

#include "gwnavruntime/blob/blobfieldarray.h"
#include "gwnavruntime/navmesh/navmeshtypes.h"
#include "gwnavruntime/blob/blobaggregate.h"

namespace Kaim
{

/// Set of Key-Values embedded within in NavData BlobAggregate (serialized form).
/// These Key-Values allows typically to retrieve information about where the NavData comes from.
class SectorDescriptorBlob
{
	KY_DEFINE_NEW_DELETE_OPERATORS(MemStat_NavData)
	KY_CLASS_WITHOUT_COPY(SectorDescriptorBlob)
	KY_ROOT_BLOB_CLASS(NavData, SectorDescriptorBlob, 0)
public:
	SectorDescriptorBlob() {}
	BlobFieldArray m_fields;
};
inline void SwapEndianness(Endianness::Target e, SectorDescriptorBlob& self)
{
	SwapEndianness(e, self.m_fields);
}

/// Easy to write/read version of SectorDescriptorBlob.
/// SectorDescriptor contains information about where the NavData comes from.
/// Written in GeneratorSectorBuilder::MakePlainSectorNavData() when generating NavMesh from the generation process
//  or in NavData::Save() when saving NavGraph-only Navdata at runtime or in user's post-process of the generation.
//  Read along with NavData Load.
/// Contains m_sectorName and m_generatorRelativeOutputDirectory, it's possible to retrieve the NavData file path
/// that was generated by the Generation by concatenating
/// GeneratorRootDirectory/m_generatorRelativeOutputDirectory/m_sectorName.EXTENSION
/// where EXTENSION is NavData or ClientInput.
class SectorDescriptor
{
	KY_DEFINE_NEW_DELETE_OPERATORS(MemStat_NavData)

public:
	SectorDescriptor() : m_databaseIndex(0) {}

	KyResult ReadFromAggregate(const BlobAggregate& aggregate)
	{
		BlobAggregate::Collection<SectorDescriptorBlob> sectorDescs = aggregate.GetCollection<SectorDescriptorBlob>();
		if (sectorDescs.GetCount() != 1)
			return KY_ERROR; // 1 and only 1 SectorDescriptorBlob
		return ReadFromBlob(*sectorDescs.GetHandler(0)->Blob());
	}

	void AddMapping(BlobFieldsMapping& mapping)
	{
		mapping.AddString("SectorName", m_sectorName);
		mapping.AddString("GeneratorRelativeOutputDirectory", m_generatorRelativeOutputDirectory);
		mapping.AddUInt32("Database index", m_databaseIndex);
	}

	KyResult ReadFromBlob(const SectorDescriptorBlob& blob)
	{
		BlobFieldsMapping mapping;
		AddMapping(mapping);
		return mapping.ReadFromBlobFieldArray(blob.m_fields);
	}

public:
	/// Contains the name of the sector which is also the name of the file
	/// This is used to identify Graph-only NavData (in opposition to NavData containing NavMeshElements) since NavGraph has no guid.
	String m_sectorName;

	/// Generator relative directory to used by the generator to output NavData, ClientInput, GenIO, related to this sector
	/// m_generatorRelativeOutputDirectory is relativeOutputDir in the call to void SetOutputDirectory(const char* absoluteOutputBaseDir, const char* relativeOutputDir);
	String m_generatorRelativeOutputDirectory;

	/// Index of the Lab's database in which the NavData will be added to.
	/// On connection, the NavData will be sent to the Game with this database index.
	KyUInt32 m_databaseIndex;
};

} // namespace Kaim

#endif
